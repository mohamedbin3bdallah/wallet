<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Users extends CI_Controller {	/**	 * Index Page for this controller.	 *	 * Maps to the following URL	 * 		http://example.com/index.php/welcome	 *	- or -	 * 		http://example.com/index.php/welcome/index	 *	- or -	 * Since this controller is set as the default controller in	 * config/routes.php, it's displayed at http://example.com/	 *	 * So any other public methods not prefixed with an underscore will	 * map to /index.php/welcome/<method_name>	 * @see http://codeigniter.com/user_guide/general/urls.html	 */	function __construct()    {		parent::__construct();		$this->mysystem = $this->Admin_mo->getrow('system',array('id'=>'1'));	    if(!$this->session->userdata('uid'))	    { 			redirect('home');	    }		else		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.utprivileges as privileges,langs.lndir as dir','users',array('usertypes'=>'users.uutid=usertypes.utid','langs'=>'users.ulang=langs.lncode'),array('users.uid'=>$this->session->userdata('uid')),'');			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('scactive'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->scid] = $section->sccode; }			}		}	}	public function index()	{		if(strpos($this->loginuser->privileges, ',usee,') !== false && in_array('U',$this->sections))		{		$data['admessage'] = '';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$employees = $this->Admin_mo->get('users'); foreach($employees as $employee) { $data['employees'][$employee->uid] = $employee->username; }		//$data['users'] = $this->Admin_mo->getjoinLeft('users.*,usertypes.utname as utname,langs.lntitle as lntitle','users',array('usertypes'=>'users.uutid = usertypes.utid','langs'=>'users.ulang = langs.lncode'),'users.uid != 1 and users.uid != '.$this->session->userdata('uid'));		$data['preporders'] = $this->Admin_mo->getjoinLeft('users.*,creditcards.*,usertypes.utname as utname,langs.lntitle as lntitle,places.pctitle as uplace,places.pcphone as pcphone','users',array('usertypes'=>'users.uutid = usertypes.utid','creditcards'=>'users.uid = creditcards.cceid','langs'=>'users.ulang = langs.lncode','places'=>'users.upcid = places.pcid'),'users.uid != 1 and users.uid != '.$this->session->userdata('uid'));		if(!empty($data['preporders']))		{			for($i=0;$i<count($data['preporders']);$i++)			{				//$data['orders'][$data['preporders'][$i]->oid] = new stdClass();				$data['users'][$data['preporders'][$i]->uid]['uid'] = $data['preporders'][$i]->uid;				$data['users'][$data['preporders'][$i]->uid]['uname'] = $data['preporders'][$i]->uname;				$data['users'][$data['preporders'][$i]->uid]['username'] = $data['preporders'][$i]->username;				$data['users'][$data['preporders'][$i]->uid]['pcphone'] = $data['preporders'][$i]->pcphone;				$data['users'][$data['preporders'][$i]->uid]['umobile'] = $data['preporders'][$i]->umobile;				$data['users'][$data['preporders'][$i]->uid]['uemail'] = $data['preporders'][$i]->uemail;				$data['users'][$data['preporders'][$i]->uid]['uplace'] = $data['preporders'][$i]->uplace;				$data['users'][$data['preporders'][$i]->uid]['uaddress'] = $data['preporders'][$i]->uaddress;				$data['users'][$data['preporders'][$i]->uid]['lntitle'] = $data['preporders'][$i]->lntitle;				$data['users'][$data['preporders'][$i]->uid]['uimage'] = $data['preporders'][$i]->uimage;				$data['users'][$data['preporders'][$i]->uid]['utname'] = $data['preporders'][$i]->utname;				$data['users'][$data['preporders'][$i]->uid]['uuid'] = $data['preporders'][$i]->uuid;				$data['users'][$data['preporders'][$i]->uid]['utime'] = $data['preporders'][$i]->utime;				$data['users'][$data['preporders'][$i]->uid]['uactive'] = $data['preporders'][$i]->uactive;								if($data['preporders'][$i]->ccnumber != '')				{					$data['users'][$data['preporders'][$i]->uid]['items'][$i]['cccode'] = $data['preporders'][$i]->ccnumber;					$data['users'][$data['preporders'][$i]->uid]['items'][$i]['ccexpire'] = $data['preporders'][$i]->ccexpire;					$data['users'][$data['preporders'][$i]->uid]['items'][$i]['cccvv'] = $data['preporders'][$i]->cccvv;				}			}		}		//echo '<pre>'; print_r($data['users']); echo '</pre>';		$this->load->view('calenderdate');		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/users',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}	public function name_validation()	{		if($_POST['val'] != '' && $_POST['val'] != ' ')		{			if(isset($_POST['id']) && $_POST['id'] != '') $where = 'uid <> '.$_POST['id'].' and';			else $where = '';			 			if(!preg_match('/[^0-9 ]/',$_POST['val'])) echo 5;			elseif(strlen($_POST['val']) < 5) echo 2;			elseif(strlen($_POST['val']) > 255) echo 3;			elseif($this->Admin_mo->exist('users','where '.$where.' uname like "'.$_POST['val'].'"','')) echo 4;			else echo 1;		}		else echo 0;	}	public function email_validation()	{		if($_POST['val'] != '' && $_POST['val'] != ' ')		{			if(isset($_POST['id']) && $_POST['id'] != '') $where = 'uid <> '.$_POST['id'].' and';			else $where = '';						if(filter_var($_POST['val'], FILTER_VALIDATE_EMAIL) === false) echo 2;			elseif($this->Admin_mo->exist('users','where '.$where.' uemail like "'.$_POST['val'].'"','')) echo 4;			else echo 1;		}		else echo 0;	}		public function password_validation()	{		if($_POST['val1'] != '')		{			if(strlen($_POST['val1']) < 6) echo 2;			elseif(strlen($_POST['val1']) > 255) echo 3;			elseif($_POST['val2'] != '' && $_POST['val2'] != ' ' && $_POST['val1'] != $_POST['val2']) echo 4;			elseif($_POST['val2'] != '' && $_POST['val2'] != ' ' && $_POST['val1'] == $_POST['val2']) echo 5;			else echo 1;		}		else echo 0;	}		public function cnfpassword_validation()	{		if($_POST['val1'] != '' && $_POST['val2'] != '')		{			if($_POST['val1'] != $_POST['val2']) echo 4;			else echo 1;		}		else echo 0;	}		public function username_validation()	{		if($_POST['val'] != '' && $_POST['val'] != ' ')		{			if(isset($_POST['id']) && $_POST['id'] != '') $where = 'uid <> '.$_POST['id'].' and';			else $where = '';						if(preg_match('/[^a-z]/',$_POST['val'])) echo 2;			elseif(strlen($_POST['val']) < 5) echo 3;			elseif(strlen($_POST['val']) >= 255) echo 5;			elseif($this->Admin_mo->exist('users','where '.$where.' username like "'.$_POST['val'].'"','')) echo 4;			else echo 1;		}		else echo 0;	}	public function add()	{		if(strpos($this->loginuser->privileges, ',uadd,') !== false && in_array('U',$this->sections))		{		$data['admessage'] = '';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$data['usertypes'] = $this->Admin_mo->getwhere('usertypes',array('utactive'=>'1','utid != '=>'1'));		$data['langs'] = $this->Admin_mo->getwhere('langs',array('lnactive'=>'1'));		$data['places'] = $this->Admin_mo->getwhere('places',array('pcactive'=>'1'));				$data['partnerships'] = $this->Admin_mo->getwhere('partnerships',array('psactive'=>'1'));				$employees = $this->Admin_mo->get('users'); 				$data['types'] = $this->Admin_mo->getjoinLeft('types.tyid as tyid,ty_d.tytitle as tytitle','ty_d',array('types'=>'ty_d.dtyid = types.tyid'),array('ty_d.tylncode'=>$this->loginuser->ulang));				//foreach($types as $type) { $data['employees'][$employee->uid] = $employee->username; }		$this->load->view('headers/user-add',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/user-add',$data);		$this->load->view('footers/user-add',$data);		$this->load->view('messages');		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}		public function create()	{		if(strpos($this->loginuser->privileges, ',uadd,') !== false && in_array('U',$this->sections))		{		    $this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->form_validation->set_error_delimiters('<div class="alert alert-danger alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>', '</div>');		$this->form_validation->set_rules('username', 'lang:username' , 'trim|alpha|required|max_length[255]|is_unique[users.username]');		$this->form_validation->set_rules('name', 'lang:name' , 'trim|required|max_length[255]|is_unique[users.uname]');		$this->form_validation->set_rules('email', 'lang:email' , 'trim|required|max_length[255]|valid_email|is_unique[users.uemail]');		$this->form_validation->set_rules('password', 'lang:password', 'trim|required|min_length[6]|max_length[255]');		$this->form_validation->set_rules('cnfpassword', 'lang:cnfpassword', 'trim|required|matches[password]');		$this->form_validation->set_rules('mobile', 'lang:mobile' , 'trim|max_length[50]|numeric');		$this->form_validation->set_rules('address', 'lang:address' , 'trim|max_length[255]');		$this->form_validation->set_rules('usertype', 'lang:usertype' , 'trim|required');		$this->form_validation->set_rules('lang', 'lang:lang' , 'trim|required');		$this->form_validation->set_rules('place', 'lang:place' , 'trim|required');				if(set_value('usertype') == '3')		{			$this->form_validation->set_rules('type', 'lang:type' , 'trim|required');						$this->form_validation->set_rules('title', 'lang:title' , 'trim|required|max_length[255]');						$this->form_validation->set_rules('partnership', 'lang:partnership' , 'trim|required');					if(isset($_FILES['logo']['error']) && $_FILES['logo']['error'] == 0) $this->form_validation->set_rules('logo', 'lang:logo' , 'callback_imageSize|callback_imageType');		}		if($this->form_validation->run() == FALSE)		{			//$data['admessage'] = 'validation error';			//$_SESSION['time'] = time(); $_SESSION['message'] = 'inputnotcorrect';			$data['title'] = 'users';			$data['system'] = $this->mysystem;			$data['usertypes'] = $this->Admin_mo->getwhere('usertypes',array('utactive'=>'1','utid != '=>'1'));			$data['langs'] = $this->Admin_mo->getwhere('langs',array('lnactive'=>'1'));			$data['places'] = $this->Admin_mo->getwhere('places',array('pcactive'=>'1'));						$data['partnerships'] = $this->Admin_mo->getwhere('partnerships',array('psactive'=>'1'));						$data['types'] = $this->Admin_mo->getjoinLeft('types.tyid as tyid,ty_d.tytitle as tytitle','ty_d',array('types'=>'ty_d.dtyid = types.tyid'),array('ty_d.tylncode'=>$this->loginuser->ulang));			$this->load->view('headers/user-add',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/user-add',$data);			$this->load->view('footers/user-add',$data);			$this->load->view('messages');		}		else		{			$set_arr = array('uuid'=>$this->session->userdata('uid'), 'uqcode'=>mt_rand(11111,99999), 'username'=>set_value('username'), 'uname'=>set_value('name'), 'uemail'=>set_value('email'), 'upassword'=>password_hash(set_value('password'), PASSWORD_BCRYPT, array('cost'=>10)), 'uutid'=>set_value('usertype'), 'ulang'=>set_value('lang'), 'umobile'=>set_value('mobile'), 'uaddress'=>set_value('address'), 'upcid'=>set_value('place'), 'uactive'=>set_value('active'), 'utime'=>time());			$uid = $this->Admin_mo->set('users', $set_arr);			if(empty($uid))			{				$data['admessage'] = 'Not Saved';				$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';				redirect('users/add', 'refresh');			}			else			{				if(set_value('usertype') == '3')				{					$partnership = $this->Admin_mo->getrow('partnerships',array('psid'=>set_value('partnership')));					$set_item_arr = array('iuid'=>$this->session->userdata('uid'), 'ieid'=>$uid, 'ipsid'=>set_value('partnership'), 'ityid'=>set_value('type'), 'ititle'=>set_value('title'), 'ifrom'=>time(), 'ito'=>(time()+(($partnership->psduration)*86400)), 'iactive'=>'1', 'itime'=>time());					if(isset($_FILES['logo']['error']) && $_FILES['logo']['error'] == 0) { $set_item_arr['iimg'] = $this->uploadimg('logo',$this->config->item('items_logos_folder'),$this->config->item('items_logos_thumb_folder'),mt_rand()); }									require_once('phpqrcode/qrlib.php');					$codeContents  = 'BEGIN:VCARD'."\n";					$codeContents .= 'VERSION:2.1'."\n";					$codeContents .= 'N:'.set_value('username')."\n";					$codeContents .= 'FN:'.set_value('name')."\n";					//$codeContents .= 'ORG:'.set_value('title')."\n";					$codeContents .= 'TEL;TYPE=cell:'.set_value('mobile')."\n";					$codeContents .= 'ADR;TYPE=work;'. 						'LABEL="'.set_value('address')					."\n";					$codeContents .= 'EMAIL:'.set_value('email')."\n";					//if(isset($update_item_arr['iimg']) && $update_item_arr['iimg'] != '') $codeContents .= 'PHOTO;JPEG;ENCODING=BASE64:'.base64_encode(file_get_contents(base_url().$this->config->item('items_logos_folder').$update_item_arr['iimg']))."\n";					//else $codeContents .= 'PHOTO;JPEG;ENCODING=BASE64:'.base64_encode(file_get_contents(base_url().$this->config->item('items_logos_folder').set_value('oldlogo')))."\n";					$codeContents .= 'END:VCARD';					$set_item_arr['iqrcode'] = mt_rand().'.png';					QRcode::png($codeContents, $this->config->item('items_qrcodes_folder').$set_item_arr['iqrcode'], QR_ECLEVEL_H, 10);					$this->Admin_mo->set('items', $set_item_arr);				}				$data['admessage'] = 'Successfully Saved';				$_SESSION['time'] = time(); $_SESSION['message'] = 'success';				redirect('users', 'refresh');			}		}		//redirect('users/add', 'refresh');		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}		public function edit($id)	{		if(strpos($this->loginuser->privileges, ',uedit,') !== false && in_array('U',$this->sections))		{		$data['admessage'] = '';		$id = abs((int)($id));		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$data['usertypes'] = $this->Admin_mo->getwhere('usertypes',array('utactive'=>'1','utid != '=>'1'));		$data['langs'] = $this->Admin_mo->getwhere('langs',array('lnactive'=>'1'));		$data['places'] = $this->Admin_mo->getwhere('places',array('pcactive'=>'1'));		$data['user'] = $this->Admin_mo->getrow('users',array('uid'=>$id));		if(!empty($data['user']))		{			$data['item'] = $this->Admin_mo->getrow('items',array('ieid'=>$id));						$data['partnerships'] = $this->Admin_mo->getwhere('partnerships',array('psactive'=>'1'));						$data['types'] = $this->Admin_mo->getjoinLeft('types.tyid as tyid,ty_d.tytitle as tytitle','ty_d',array('types'=>'ty_d.dtyid = types.tyid'),array('ty_d.tylncode'=>$this->loginuser->ulang));			$this->load->view('headers/user-edit',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/user-edit',$data);			$this->load->view('footers/user-edit');			$this->load->view('messages');		}		else		{			$data['title'] = 'users';			$data['admessage'] = 'youhavenoprivls';			$this->load->view('headers/users',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/messages',$data);			$this->load->view('footers/users');			$this->load->view('messages');		}		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}		public function edituser($id)	{		if(strpos($this->loginuser->privileges, ',uedit,') !== false && in_array('U',$this->sections))		{		$id = abs((int)($id));		if($id != '')		{		    $this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$this->config->set_item('language', $this->loginuser->ulang);			$this->form_validation->set_error_delimiters('<div class="alert alert-danger alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>', '</div>');			$this->form_validation->set_rules('username', 'lang:username' , 'trim|alpha|required|max_length[255]');			$this->form_validation->set_rules('name', 'lang:name' , 'trim|required|max_length[255]');			$this->form_validation->set_rules('email', 'lang:email' , 'trim|required|max_length[255]|valid_email');			$this->form_validation->set_rules('password', 'lang:password', 'trim|min_length[6]|max_length[255]');			$this->form_validation->set_rules('cnfpassword', 'lang:cnfpassword', 'trim|matches[password]');			$this->form_validation->set_rules('mobile', 'lang:mobile' , 'trim|max_length[50]|numeric');			$this->form_validation->set_rules('address', 'lang:address' , 'trim|max_length[255]');			$this->form_validation->set_rules('usertype', 'lang:usertype' , 'trim|required');			$this->form_validation->set_rules('lang', 'lang:lang' , 'trim|required');			$this->form_validation->set_rules('place', 'lang:place' , 'trim|required');						if(set_value('usertype') == '3')			{				$this->form_validation->set_rules('type', 'lang:type' , 'trim|required');							$this->form_validation->set_rules('title', 'lang:title' , 'trim|required|max_length[255]');								$this->form_validation->set_rules('partnership', 'lang:partnership' , 'trim|required');						if(isset($_FILES['logo']['error']) && $_FILES['logo']['error'] == 0) $this->form_validation->set_rules('logo', 'lang:logo' , 'callback_imageSize|callback_imageType');			}			if($this->form_validation->run() == FALSE)			{				//$data['admessage'] = 'validation error';				//$_SESSION['time'] = time(); $_SESSION['message'] = 'inputnotcorrect';				$data['system'] = $this->mysystem;				$data['usertypes'] = $this->Admin_mo->getwhere('usertypes',array('utactive'=>'1','utid != '=>'1'));				$data['langs'] = $this->Admin_mo->getwhere('langs',array('lnactive'=>'1'));				$data['places'] = $this->Admin_mo->getwhere('places',array('pcactive'=>'1'));				$data['user'] = $this->Admin_mo->getrow('users',array('uid'=>$id));								$data['item'] = $this->Admin_mo->getrow('items',array('ieid'=>$id));								$data['partnerships'] = $this->Admin_mo->getwhere('partnerships',array('psactive'=>'1'));							$data['types'] = $this->Admin_mo->getjoinLeft('types.tyid as tyid,ty_d.tytitle as tytitle','ty_d',array('types'=>'ty_d.dtyid = types.tyid'),array('ty_d.tylncode'=>$this->loginuser->ulang));				$this->load->view('headers/user-edit',$data);				$this->load->view('sidemenu',$data);				$this->load->view('topmenu',$data);				$this->load->view('admin/user-edit',$data);				$this->load->view('footers/user-edit');				$this->load->view('messages');			}			else			{				if($this->Admin_mo->exist('users','where uid <> '.$id.' and username like "'.set_value('username').'"',''))				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'usernameexist';					redirect('users/edit/'.$id, 'refresh');				}				if($this->Admin_mo->exist('users','where uid <> '.$id.' and uname like "'.set_value('name').'"',''))				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'nameexist';					redirect('users/edit/'.$id, 'refresh');				}				if($this->Admin_mo->exist('users','where uid <> '.$id.' and uemail like "'.set_value('email').'"',''))				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'emailexist';					redirect('users/edit/'.$id, 'refresh');				}				else				{					$update_array = array('uuid'=>$this->session->userdata('uid'), 'username'=>set_value('username'), 'uname'=>set_value('name'), 'uemail'=>set_value('email'), 'uutid'=>set_value('usertype'), 'ulang'=>set_value('lang'), 'umobile'=>set_value('mobile'), 'uaddress'=>set_value('address'), 'upcid'=>set_value('place'), 'uactive'=>set_value('active'), 'utime'=>time());					if(set_value('password') != '' && set_value('password') != ' ')  $update_array['upassword'] = password_hash(set_value('password'), PASSWORD_BCRYPT, array('cost'=>10));					if($this->Admin_mo->update('users', $update_array, array('uid'=>$id)))					{						if(set_value('usertype') == '3')						{							$partnership = $this->Admin_mo->getrow('partnerships',array('psid'=>set_value('partnership')));							$update_item_arr = array('iuid'=>$this->session->userdata('uid'), 'ieid'=>$id, 'ipsid'=>set_value('partnership'),'ityid'=>set_value('type'), 'ititle'=>set_value('title'), 'ifrom'=>time(), 'ito'=>(time()+(($partnership->psduration)*86400)), 'iactive'=>'1', 'itime'=>time());							if(isset($_FILES['logo']['error']) && $_FILES['logo']['error'] == 0) { $update_item_arr['iimg'] = $this->uploadimg('logo',$this->config->item('items_logos_folder'),$this->config->item('items_logos_thumb_folder'),mt_rand()); if($update_item_arr['iimg'] != '' && set_value('oldlogo') != '' && file_exists($this->config->item('items_logos_folder').set_value('oldlogo'))) unlink($this->config->item('items_logos_folder').set_value('oldlogo')); if(file_exists($this->config->item('items_logos_thumb_folder').set_value('oldlogo'))) unlink($this->config->item('items_logos_thumb_folder').set_value('oldlogo')); }							require_once('phpqrcode/qrlib.php');							$codeContents  = 'BEGIN:VCARD'."\n";							$codeContents .= 'VERSION:2.1'."\n";							$codeContents .= 'N:'.set_value('username')."\n";							$codeContents .= 'FN:'.set_value('name')."\n";							//$codeContents .= 'ORG:'.set_value('title')."\n";							$codeContents .= 'TEL;TYPE=cell:'.set_value('mobile')."\n";							$codeContents .= 'ADR;TYPE=work;'. 								'LABEL="'.set_value('address')							."\n";							$codeContents .= 'EMAIL:'.set_value('email')."\n";							//if(isset($update_item_arr['iimg']) && $update_item_arr['iimg'] != '') $codeContents .= 'PHOTO;JPEG;ENCODING=BASE64:'.base64_encode(file_get_contents(base_url().$this->config->item('items_logos_folder').$update_item_arr['iimg']))."\n";							//else $codeContents .= 'PHOTO;JPEG;ENCODING=BASE64:'.base64_encode(file_get_contents(base_url().$this->config->item('items_logos_folder').set_value('oldlogo')))."\n";							$codeContents .= 'END:VCARD';							$update_item_arr['iqrcode'] = mt_rand().'.png';							QRcode::png($codeContents, $this->config->item('items_qrcodes_folder').$update_item_arr['iqrcode'], QR_ECLEVEL_H, 10);							if($update_item_arr['iqrcode'] != '' && set_value('oldqrcode') != '' && file_exists($this->config->item('items_qrcodes_folder').set_value('oldqrcode'))) unlink($this->config->item('items_qrcodes_folder').set_value('oldqrcode'));							$this->Admin_mo->update('items', $update_item_arr, array('iid'=>set_value('item')));						}						$_SESSION['time'] = time(); $_SESSION['message'] = 'success';					}					else					{						$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';					}					redirect('users', 'refresh');				}			}		}		else		{			$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';			redirect('users', 'refresh');		}		//redirect('users', 'refresh');		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}	public function del($id)	{		$id = abs((int)($id));		if(strpos($this->loginuser->privileges, ',udelete,') !== false && $id != '1' && in_array('U',$this->sections))		{		$user = $this->Admin_mo->getrow('users', array('uid'=>$id));		if(!empty($user))		{			if($user->uimage != '' && file_exists($this->config->item('users_folder').$user->uimage)) unlink($this->config->item('users_folder').$user->uimage);			if(file_exists($this->config->item('users_thumb_folder').$user->uimage)) unlink($this->config->item('users_thumb_folder').$user->uimage);			$this->Admin_mo->del('users', array('uid'=>$id));			$_SESSION['time'] = time(); $_SESSION['message'] = 'success';			redirect('users', 'refresh');		}		else		{			$data['title'] = 'users';			$data['admessage'] = 'youhavenoprivls';			$data['system'] = $this->mysystem;			$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);			$this->config->set_item('language', $this->loginuser->ulang);			$this->load->view('headers/users',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/messages',$data);			$this->load->view('footers/users');			$this->load->view('messages');		}		}		else		{		$data['title'] = 'users';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->ulang, $this->loginuser->ulang);		$this->config->set_item('language', $this->loginuser->ulang);		$this->load->view('headers/users',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/users');		$this->load->view('messages');		}	}			public function imageSize()	{		if ($_FILES['logo']['size'] > 1024000)		{			//$this->form_validation->set_message('imageSize', 'يجب ان يكون حجم الصورة 1 ميجا او اقل');			return FALSE;		}		else		{			return TRUE;		}	}		public function imageType()	{		if (!in_array(strtoupper(pathinfo($_FILES['logo']['name'], PATHINFO_EXTENSION)),array('JPG','JPEG','PNG','JIF','BMP','TIF')))		{			//$this->form_validation->set_message('imageType', 'يجب ان يكون نوع الملف المرفوع واحد من هذه الانواع : JPG,JPEG,PNG,JIF,BMP,TIF');			return FALSE;		}		else		{			return TRUE;		}	}		public function uploadimg($inputfilename,$image_director,$image_director_thumb,$newname)	{		$file_extn = pathinfo($_FILES[$inputfilename]['name'], PATHINFO_EXTENSION);		if(!is_dir($image_director)) $create_image_director = mkdir($image_director);		$name = $newname.".".$file_extn;		if(move_uploaded_file($_FILES[$inputfilename]["tmp_name"], $image_director.$name))		{			if($image_director_thumb != '')			{				$this->load->library('Resize');				$this->resize->construct($image_director.$name);				$this->resize->resizeImage(210, 210, 'exact');				$this->resize->saveImage($image_director_thumb.$name, 100);			}			return $name;		}		else return '';	}}